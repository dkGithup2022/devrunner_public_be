
# workflow ëª…

name: prod environment for "api-application" | devrunner

run-name: ${{github.actor}} is publish deploy on "api-application" & devrunner prod env
on:
  push:
    branches:
      - devrunner/api/prod
jobs:
  Explore-Github-Actions:
    runs-on: ubuntu-latest
    steps:
      # print ubuntu & repo info
      - run: echo "initial job echo this sentence ~ "
      - run: echo "event :${{github.event_name}} "
      - run: echo "os = ${{runner.os}} "
      - run: echo "branch = ${{ github.ref }} ."
      - run: echo "repo = ${{ github.repository }}."

      # checkout source s:
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."

      # java config -> 21 versin  & temurin
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'  # JDK ë²„ì „ì„ 21ë¡œ ì„¤ì •
          distribution: 'temurin'  # Eclipse Temurinì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

      # gradle build í•˜ê¸°
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.5


      - name: Build with Gradle
        uses: gradle/gradle-build-action@v3
        with:
          arguments: ':modules:applications:api-application:bootJar'

      # íŒ¨í‚¤ì§• ëœ jar íŒŒì¼ app.jar ë¡œ ì˜®ê¸°ê¸°
      - name: Copy Jar file
        run: mv modules/applications/api-application/build/libs/$(ls modules/applications/api-application/build/libs) app.jar

      -
        name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO_API }}

      # try login docker hub
      - name: log in to docker hub
        uses: docker/login-action@v3
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - run: echo "docker hub logged in ~ "

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile                     #ë¹Œë“œ ì‹œ ì‚¬ìš©í•  Dockerfileì˜ ìœ„ì¹˜ ì§€ì •
          platforms: linux/amd64                 #ì´ë¯¸ì§€ ë“±ë¡ ì‹œ Platform ì´ë¦„ ì§€ì •
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO_API }}:latest
          labels: ${{ steps.meta.outputs.labels }}
